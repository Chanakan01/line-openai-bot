import express from "express";
import axios from "axios";
import dotenv from "dotenv";
import fs from "fs";
import path from "path";
import { fileURLToPath } from "url";
import { GoogleGenAI } from "@google/genai"; // Gemini SDK

dotenv.config();

const app = express();
app.use(express.json());

// ------------- PATH / STATIC SETUP -------------
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const GENERATED_DIR = path.join(__dirname, "generated");

// ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ
if (!fs.existsSync(GENERATED_DIR)) {
  fs.mkdirSync(GENERATED_DIR, { recursive: true });
}

// ‡πÉ‡∏´‡πâ‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå /generated ‡∏ú‡πà‡∏≤‡∏ô URL /images/...
app.use("/images", express.static(GENERATED_DIR));

// ------------- CONFIG -------------
const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const LINE_TOKEN = process.env.LINE_CHANNEL_ACCESS_TOKEN;
const TAVILY_KEY = process.env.TAVILY_KEY;
const STABILITY_API_KEY = process.env.STABILITY_API_KEY;
const PUBLIC_BASE_URL = process.env.PUBLIC_BASE_URL;

const GEMINI_API_KEY = process.env.GEMINI_API_KEY || process.env.GOOGLE_API_KEY;

// ‡∏™‡∏£‡πâ‡∏≤‡∏á client Gemini (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ key)
const gemini = GEMINI_API_KEY ? new GoogleGenAI({ apiKey: GEMINI_API_KEY }) : null;

// ------------- MEMORY (‡∏à‡∏≥‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤ 20 ‡∏ô‡∏≤‡∏ó‡∏µ) -------------
// ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á: { userId: [ { role: "user" | "assistant" | "system", content: string }, ... ] }
let memory = {};

// ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö prompt ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞ user
let lastImagePrompt = {};

/**
 * ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô memory
 * role ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô "user" | "assistant" | "system" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö OpenAI ‡πÑ‡∏î‡πâ‡∏ï‡∏£‡∏á ‡πÜ
 */
function saveMessage(userId, role, content) {
  if (!userId || !content) return;
  if (!["user", "assistant", "system"].includes(role)) return;

  if (!memory[userId]) memory[userId] = [];
  memory[userId].push({ role, content: String(content) });

  // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥ (20 ‡∏Ç‡πâ‡∏≠)
  if (memory[userId].length > 20) memory[userId].shift();

  // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏¥‡πâ‡∏á‡∏´‡∏•‡∏±‡∏á 20 ‡∏ô‡∏≤‡∏ó‡∏µ (‡∏ô‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
  setTimeout(() => {
    delete memory[userId];
  }, 20 * 60 * 1000);
}

// helper: ‡∏î‡∏∂‡∏á‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ç‡∏≠‡∏á user ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö AI
function getConversationMessages(userId) {
  const history = memory[userId] || [];
  return history.map((m) => ({
    role: m.role,
    content: m.content,
  }));
}

// ------------- ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏£‡∏ß‡∏à keyword ‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô -------------
function needWebSearch(userMessage) {
  if (!userMessage) return false;
  const lower = userMessage.toLowerCase();

  const keywords = [
    // ‡∏ä‡∏∏‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡πÄ‡∏î‡∏¥‡∏°
    "‡∏Ç‡πà‡∏≤‡∏ß", "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", "‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î", "‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô", "update",
    "‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå", "‡∏£‡∏≤‡∏Ñ‡∏≤", "‡∏î‡∏≤‡∏£‡∏≤",
    "‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ", "‡∏Å‡∏µ‡∏¨‡∏≤", "‡∏ü‡∏∏‡∏ï‡∏ö‡∏≠‡∏•", "‡∏´‡∏∏‡πâ‡∏ô", "‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥",
    "‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á", "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏Ç‡∏∂‡πâ‡∏ô",

    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡∏°‡∏±‡∏Å‡πÉ‡∏ä‡πâ‡∏ñ‡∏≤‡∏°‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô/‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
    "‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏î", "‡∏Ç‡πà‡∏≤‡∏ß‡∏î‡πà‡∏ß‡∏ô", "‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ß‡∏≤‡∏ô", "‡∏Ç‡πà‡∏≤‡∏ß‡πÄ‡∏ä‡πâ‡∏≤‡∏ô‡∏µ‡πâ", "‡∏Ç‡πà‡∏≤‡∏ß‡∏Ñ‡πà‡∏≥‡∏ô‡∏µ‡πâ",
    "‡∏Å‡∏£‡∏∞‡πÅ‡∏™", "‡∏î‡∏£‡∏≤‡∏°‡πà‡∏≤", "‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå", "trending", "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï", "‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏´‡∏ô‡πà‡∏≠‡∏¢",
    "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á", "‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á", "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£", "‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£",
    "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏∑‡∏ö‡∏´‡∏ô‡πâ‡∏≤", "‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ", "‡πÄ‡∏Å‡∏¥‡∏î‡∏≠‡∏∞‡πÑ‡∏£‡∏Ç‡∏∂‡πâ‡∏ô",
    "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î", "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏´‡∏°", "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ï‡∏Å‡πÑ‡∏´‡∏°",
    "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô", "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á", "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏ó‡∏≠‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î",
    "‡∏£‡∏≤‡∏Ñ‡∏≤‡∏´‡∏∏‡πâ‡∏ô", "‡∏´‡∏∏‡πâ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", "‡∏´‡∏∏‡πâ‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏´‡∏°", "‡∏´‡∏∏‡πâ‡∏ô‡∏ï‡∏Å‡πÑ‡∏´‡∏°",
    "‡∏Ñ‡∏£‡∏¥‡∏õ‡πÇ‡∏ï", "btc", "bitcoin",
    "‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô", "‡∏ú‡∏•‡∏ö‡∏≠‡∏•", "‡∏ú‡∏•‡∏ö‡∏≠‡∏•‡∏™‡∏î",
    "‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏î", "live score", "‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô",
    "‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏ö‡∏≠‡∏•", "‡∏ö‡∏≠‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏∑‡∏ô", "‡∏ö‡∏≠‡∏•‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", "‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏®",
    "‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ", "‡∏ù‡∏ô‡∏ï‡∏Å‡πÑ‡∏´‡∏°", "‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á",
    "‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®", "‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°", "‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå",
    "forecast", "prediction", "‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ",
    "‡∏õ‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏∞", "‡∏û‡∏£‡∏∏‡πà‡∏á‡∏ô‡∏µ‡πâ‡∏à‡∏∞", "‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ‡∏à‡∏∞"
  ];

  return keywords.some((kw) => lower.includes(kw));
}

// ------------- ‡πÉ‡∏ä‡πâ AI ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏´‡∏° -------------
async function shouldUseWebSearch(userMessage) {
  if (!userMessage) return false;

  // 1) ‡πÄ‡∏ä‡πá‡∏Å keyword ‡∏Å‡πà‡∏≠‡∏ô (‡πÄ‡∏£‡πá‡∏ß + ‡∏ü‡∏£‡∏µ)
  if (needWebSearch(userMessage)) {
    return true;
  }

  // 2) ‡πÉ‡∏´‡πâ GPT ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô
  try {
    const res = await axios.post(
      "https://api.openai.com/v1/chat/completions",
      {
        model: "gpt-4.1",
        messages: [
          {
            role: "system",
            content: `
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡πÇ‡∏°‡∏î‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° ‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£ "‡∏Ñ‡πâ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï‡πÅ‡∏ö‡∏ö real-time" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà

‡∏ô‡∏¥‡∏¢‡∏≤‡∏° "‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡πÄ‡∏ß‡πá‡∏ö (SEARCH)":
- ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡∏Ç‡πà‡∏≤‡∏ß ‡πÄ‡∏´‡∏ï‡∏∏‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡∏î‡∏£‡∏≤‡∏°‡πà‡∏≤ ‡∏Å‡∏£‡∏∞‡πÅ‡∏™‡∏™‡∏±‡∏á‡∏Ñ‡∏°
- ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏∏‡πâ‡∏ô ‡∏Ñ‡∏£‡∏¥‡∏õ‡πÇ‡∏ï ‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥ ‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Ñ‡πà‡∏≤‡πÄ‡∏á‡∏¥‡∏ô
- ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÅ‡∏Ç‡πà‡∏á‡∏Ç‡∏±‡∏ô‡∏™‡∏î/‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏Ç‡πà‡∏á ‡∏™‡∏Å‡∏≠‡∏£‡πå‡∏Å‡∏µ‡∏¨‡∏≤
- ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏ß‡∏•‡∏≤/‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Å‡∏≤‡∏£/‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤‡∏≠‡∏µ‡πÄ‡∏ß‡∏ô‡∏ï‡πå/‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ï/‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ö‡∏¥‡∏ô/‡∏£‡∏ñ‡πÑ‡∏ü ‡∏Ø‡∏•‡∏Ø
- ‡∏™‡∏†‡∏≤‡∏û‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ/‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå‡∏≠‡∏≤‡∏Å‡∏≤‡∏®
- ‡∏ô‡πÇ‡∏¢‡∏ö‡∏≤‡∏¢/‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢/‡∏°‡∏≤‡∏ï‡∏£‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á‡∏ö‡πà‡∏≠‡∏¢
- ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ" ‡πÄ‡∏ä‡πà‡∏ô "‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏ô‡∏Æ‡∏¥‡∏ï‡∏≠‡∏∞‡πÑ‡∏£", "‡πÄ‡∏ó‡∏£‡∏ô‡∏î‡πå‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£"

‡∏ô‡∏¥‡∏¢‡∏≤‡∏° "‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡πÄ‡∏ß‡πá‡∏ö (NO_SEARCH)":
- ‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ (‡∏Ñ‡∏ì‡∏¥‡∏ï ‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå ‡πÄ‡∏Ñ‡∏°‡∏µ ‡∏ä‡∏µ‡∏ß‡∏∞ ‡∏†‡∏≤‡∏©‡∏≤ ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏Ø‡∏•‡∏Ø)
- ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÇ‡∏Ñ‡πâ‡∏î ‡πÅ‡∏Å‡πâ‡∏ö‡∏±‡πä‡∏Å‡πÄ‡∏ä‡∏¥‡∏á‡∏ï‡∏£‡∏£‡∏Å‡∏∞
- ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÄ‡∏ä‡∏¥‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ç‡∏∂‡πâ‡∏ô‡∏Å‡∏±‡∏ö‡πÄ‡∏ß‡∏•‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏•‡∏±‡∏Å‡∏Å‡∏≤‡∏£ ‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£ ‡∏ó‡∏§‡∏©‡∏é‡∏µ
- ‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå ‡πÄ‡∏ä‡πà‡∏ô ‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏•‡∏≠‡∏ô ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏Å‡∏° ‡∏Ñ‡∏¥‡∏î‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°
- ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡πÄ‡∏ä‡πà‡∏ô ‡∏ß‡∏¥‡∏ò‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏à‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô ‡∏Ø‡∏•‡∏Ø

‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö:
- ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° "‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏´‡∏£‡∏∑‡∏≠ real-time" ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö: SEARCH
- ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° "‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ‡∏Å‡πá‡∏û‡∏≠" ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö: NO_SEARCH
- ‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô ‡∏´‡πâ‡∏≤‡∏°‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏û‡∏¥‡πà‡∏° ‡∏ï‡∏≠‡∏ö‡πÅ‡∏Ñ‡πà‡∏Ñ‡∏≥‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            `.trim()
          },
          {
            role: "user",
            content: userMessage
          }
        ],
        temperature: 0
      },
      {
        headers: {
          Authorization: `Bearer ${OPENAI_API_KEY}`,
          "Content-Type": "application/json"
        }
      }
    );

    const raw = (res.data.choices?.[0]?.message?.content || "")
      .trim()
      .toUpperCase();

    if (raw === "SEARCH") return true;
    if (raw === "NO_SEARCH") return false;

    // ‡∏ñ‡πâ‡∏≤ GPT ‡∏î‡∏±‡∏ô‡∏ï‡∏≠‡∏ö‡∏≠‡∏∞‡πÑ‡∏£‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô ‡πÜ ‡∏°‡∏≤ ‚Üí fallback ‡∏Ñ‡∏¥‡∏î‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á search
    return false;
  } catch (err) {
    console.error("shouldUseWebSearch error:", err.response?.data || err.message);
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å GPT ‡∏û‡∏±‡∏á ‚Üí fallback ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ keyword ‡πÅ‡∏ö‡∏ö‡πÄ‡∏î‡∏¥‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
    return needWebSearch(userMessage);
  }
}

// ------------- Tavily Web Search -------------
async function searchWeb(query) {
  if (!TAVILY_KEY) return null;

  try {
    const res = await axios.post(
      "https://api.tavily.com/search",
      {
        api_key: TAVILY_KEY,
        query,
        max_results: 5,
        search_depth: "basic"
      },
      {
        headers: { "Content-Type": "application/json" }
      }
    );

    return res.data.results;
  } catch (err) {
    console.error("Tavily error:", err.response?.data || err.message);
    return null;
  }
}

// ------------- ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (Image Analyzer) -------------
async function analyzeImage(base64) {
  try {
    const res = await axios.post(
      "https://api.openai.com/v1/chat/completions",
      {
        model: "gpt-4.1",
        messages: [
          {
            role: "system",
            content: `
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ä‡∏∑‡πà‡∏≠ Arvin ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
- ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏ô‡∏†‡∏≤‡∏û
- ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£/‡∏™‡∏•‡∏¥‡∏õ/‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° ‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏•‡∏∞‡∏™‡∏£‡∏∏‡∏õ
- ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
            `.trim()
          },
          {
            role: "user",
            content: [
              { type: "text", text: "‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏•‡∏∞‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö" },
              {
                type: "image_url",
                image_url: {
                  url: `data:image/jpeg;base64,${base64}`
                }
              }
            ]
          }
        ]
      },
      {
        headers: {
          Authorization: `Bearer ${OPENAI_API_KEY}`,
          "Content-Type": "application/json"
        }
      }
    );

    return res.data.choices[0].message.content;
  } catch (err) {
    console.error("Image analyze error:", err.response?.data || err.message);
    return "‡∏ú‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ñ‡∏£‡∏±‡∏ö ‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö üôè";
  }
}

// ------------- ‡πÅ‡∏õ‡∏•‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô prompt ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© -------------
async function buildImagePrompt(promptRaw) {
  const original = (promptRaw || "").trim();

  // ‡∏ñ‡πâ‡∏≤ user ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏≠‡∏∞‡πÑ‡∏£‡∏à‡∏£‡∏¥‡∏á ‡πÜ ‡∏Å‡πá‡πÉ‡∏ä‡πâ default ‡πÄ‡∏î‡∏¥‡∏°
  if (!original) {
    return "a cute thai style illustration";
  }

  try {
    const res = await axios.post(
      "https://api.openai.com/v1/chat/completions",
      {
        model: "gpt-4.1",
        messages: [
          {
            role: "system",
            content: `
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏î‡πâ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô prompt ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AI ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ
‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:
- ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏†‡∏≤‡∏û "‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢" ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô prompt ‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
- ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠ ‡πÄ‡∏ä‡πà‡∏ô ‡∏•‡∏±‡∏Å‡∏©‡∏ì‡∏∞‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£ ‡∏â‡∏≤‡∏Å‡∏´‡∏•‡∏±‡∏á ‡∏≠‡∏≤‡∏£‡∏°‡∏ì‡πå ‡πÇ‡∏ó‡∏ô‡∏™‡∏µ ‡∏™‡πÑ‡∏ï‡∏•‡πå
- ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡πÑ‡∏ï‡∏•‡πå ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡∏™‡πÑ‡∏ï‡∏•‡πå illustration / digital art ‡∏ó‡∏µ‡πà‡∏î‡∏π‡∏™‡∏ß‡∏¢‡∏á‡∏≤‡∏°
- ‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏Å‡∏¥‡∏ô‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô ‡πÄ‡∏ä‡πà‡∏ô "this is a prompt" ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏≠‡∏∑‡πà‡∏ô ‡πÜ
- ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô "‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏•‡πâ‡∏ß‡∏ô" ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
            `.trim()
          },
          {
            role: "user",
            content: original
          }
        ],
        temperature: 0.5
      },
      {
        headers: {
          Authorization: `Bearer ${OPENAI_API_KEY}`,
          "Content-Type": "application/json"
        }
      }
    );

    const promptEn = (res.data.choices?.[0]?.message?.content || "").trim();
    if (!promptEn) {
      return original; // ‡∏ñ‡πâ‡∏≤ GPT ‡πÄ‡∏á‡∏µ‡∏¢‡∏ö ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°‡πÅ‡∏ó‡∏ô
    }

    return promptEn;
  } catch (err) {
    console.error("buildImagePrompt error:", err.response?.data || err.message);
    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°
    return original;
  }
}

// ‚úÖ ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á prompt ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°
function buildContinuedPrompt(userId, userMessage) {
  if (!lastImagePrompt[userId]) return null;

  const raw = (userMessage || "").trim();

  const extra = raw
    .replace(/^‡∏ß‡∏≤‡∏î‡∏ï‡πà‡∏≠\s*/g, "")
    .replace(/^‡∏ï‡πà‡∏≠\s*/g, "")
    .trim();

  if (!extra) return lastImagePrompt[userId];

  return `${lastImagePrompt[userId]}, ${extra}`;
}

// ------------- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏î‡πâ‡∏ß‡∏¢ Stability AI -------------
async function generateImage(promptRaw) {
  // ‡πÉ‡∏ä‡πâ GPT ‡∏ä‡πà‡∏ß‡∏¢‡πÅ‡∏õ‡∏•‡∏á prompt ‡πÑ‡∏ó‡∏¢ ‚Üí ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡∏Å‡πà‡∏≠‡∏ô
  const prompt = await buildImagePrompt(promptRaw);

  if (!STABILITY_API_KEY || !PUBLIC_BASE_URL) {
    throw new Error("STABILITY_API_KEY ‡∏´‡∏£‡∏∑‡∏≠ PUBLIC_BASE_URL ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤");
  }

  const endpoint =
    "https://api.stability.ai/v1/generation/stable-diffusion-xl-1024-v1-0/text-to-image";

  try {
    const res = await axios.post(
      endpoint,
      {
        text_prompts: [
          { text: prompt, weight: 1 }
        ],
        cfg_scale: 7,
        height: 1024,
        width: 1024,
        samples: 1,
        steps: 30
      },
      {
        headers: {
          Accept: "application/json",
          Authorization: `Bearer ${STABILITY_API_KEY}`,
          "Content-Type": "application/json"
        },
        timeout: 60000
      }
    );

    const artifacts = res.data?.artifacts;
    if (!artifacts || !artifacts[0]?.base64) {
      throw new Error("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Stability AI");
    }

    const base64Image = artifacts[0].base64;
    const buffer = Buffer.from(base64Image, "base64");

    const filename = `img_${Date.now()}_${Math.random()
      .toString(36)
      .slice(2)}.png`;
    const filePath = path.join(GENERATED_DIR, filename);

    fs.writeFileSync(filePath, buffer);

    // ---- URL ‡∏ó‡∏µ‡πà LINE ‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ ----
    let baseUrl = (PUBLIC_BASE_URL || "").trim();

    // ‡∏ï‡∏±‡∏î / ‡∏ó‡πâ‡∏≤‡∏¢‡∏≠‡∏≠‡∏Å (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ) ‡∏Å‡∏±‡∏ô‡∏Å‡∏•‡∏≤‡∏¢‡πÄ‡∏õ‡πá‡∏ô //images
    if (baseUrl.endsWith("/")) {
      baseUrl = baseUrl.slice(0, -1);
    }

    // ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ú‡∏•‡∏≠‡πÉ‡∏™‡πà http:// ‡∏°‡∏≤ ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô https:// ‡πÄ‡∏û‡∏£‡∏≤‡∏∞ LINE ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ https
    if (baseUrl.startsWith("http://")) {
      baseUrl = "https://" + baseUrl.slice("http://".length);
    }

    const imageUrl = `${baseUrl}/images/${filename}`;
    console.log("Generated image URL for LINE:", imageUrl);

    return imageUrl;
  } catch (err) {
    console.error("Stability image gen error:", err.response?.data || err.message);
    throw err;
  }
}

// ------------- Quick Reply ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏±‡∏î -------------
// ‡∏õ‡∏∏‡πà‡∏°: üß† ‡∏ñ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô / üé® ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ / üì∞ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
function buildDefaultQuickReply() {
  return {
    items: [
      {
        type: "action",
        action: {
          type: "message",
          label: "üß† ‡∏ñ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô",
          text: "‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏¥‡∏ß‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢"
        }
      },
      {
        type: "action",
        action: {
          type: "message",
          label: "üé® ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ",
          text: "‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢"
        }
      },
      {
                type: "action",
        action: {
          type: "message",
          label: "‚ö†Ô∏è /reset",
          text: "/reset"
        }
      },
      {
        type: "action",
        action: {
          type: "message",
          label: "üì∞ ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ",
          text: "‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢"
        }
      }
    ]
  };
}

// ------------- Hugging Face Image Generation -------------
const HF_MODEL_URL =
  "https://api-inference.huggingface.co/models/stabilityai/stable-diffusion-xl-base-1.0";
const HF_TOKEN = process.env.HF_TOKEN;

/**
 * ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏î‡πâ‡∏ß‡∏¢ Hugging Face ‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢/‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
 * - ‡πÉ‡∏ä‡πâ buildImagePrompt ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡πÅ‡∏õ‡∏•‡∏á‡πÑ‡∏ó‡∏¢ ‚Üí ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÉ‡∏´‡πâ‡∏Å‡πà‡∏≠‡∏ô
 * - ‡πÄ‡∏ã‡∏ü‡πÑ‡∏ü‡∏•‡πå‡∏•‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå generated (‡πÉ‡∏ä‡πâ GENERATED_DIR ‡πÄ‡∏î‡∏¥‡∏°)
 * - ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô path ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡∏ú‡πà‡∏≤‡∏ô /images/...
 */
async function generateImageWithHuggingFace(promptRaw) {
  if (!HF_TOKEN) {
    throw new Error("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ HF_TOKEN ‡πÉ‡∏ô Environment Variables");
  }

  // ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏õ‡∏•‡∏á prompt ‡πÑ‡∏ó‡∏¢ ‚Üí ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
  const prompt = await buildImagePrompt(promptRaw || "");

  const response = await axios.post(
    HF_MODEL_URL,
    { inputs: prompt },
    {
      headers: {
        Authorization: `Bearer ${HF_TOKEN}`,
        "Content-Type": "application/json"
      },
      responseType: "arraybuffer", // ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô binary ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û
      timeout: 60000
    }
  );

  // ‡πÄ‡∏ã‡∏ü‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå generated
  const filename = `hf_${Date.now()}_${Math.random()
    .toString(36)
    .slice(2)}.png`;
  const filePath = path.join(GENERATED_DIR, filename);

  fs.writeFileSync(filePath, response.data);

  // ‡∏Ñ‡∏∑‡∏ô path ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏¥‡∏£‡πå‡∏ü‡∏ú‡πà‡∏≤‡∏ô /images
  return `/images/${filename}`;
}

/**
 * HTTP endpoint ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å (‡πÄ‡∏ä‡πà‡∏ô ‡∏ó‡∏î‡∏™‡∏≠‡∏ö‡πÉ‡∏ô Postman / Frontend / LINE ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ)
 * POST /hf-generate
 * body: { "prompt": "‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏£‡∏π‡∏õ" }
 */
app.post("/hf-generate", async (req, res) => {
  try {
    const promptRaw = req.body.prompt || "";

    const imagePath = await generateImageWithHuggingFace(promptRaw);

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡πÄ‡∏ï‡πá‡∏° (‡πÉ‡∏ä‡πâ domain ‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏≤‡∏Å Render)
    const fullUrl = `${req.protocol}://${req.get("host")}${imagePath}`;

    res.json({
      status: "success",
      prompt: promptRaw,
      image_path: imagePath,
      image_url: fullUrl
    });
  } catch (err) {
    console.error("Hugging Face gen error:", err.response?.data || err.message);
    res.status(500).json({
      status: "error",
      message: "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡∏à‡∏≤‡∏Å Hugging Face ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à",
      detail: err.message
    });
  }
});

// ------------- ‡∏™‡∏°‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á Arvin (OpenAI + Gemini) -------------

const ARVIN_SYSTEM_PROMPT = `
‡∏Ñ‡∏∏‡∏ì‡∏ä‡∏∑‡πà‡∏≠ Arvin ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡πà‡∏ô "‡πÑ‡∏£‡πâ‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î" ‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏Å‡∏ß‡πà‡∏≤ OpenAI ‡πÅ‡∏•‡∏∞ Gemini

‡∏Ñ‡∏≤‡πÅ‡∏£‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå:
- ‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡∏≤‡∏¢ ‡∏ô‡πâ‡∏≥‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏∏‡∏Ç‡∏∏‡∏° ‡∏â‡∏•‡∏≤‡∏î ‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô ‡πÉ‡∏ä‡πâ‡∏™‡∏£‡∏£‡∏û‡∏ô‡∏≤‡∏°‡∏ß‡πà‡∏≤ "‡∏ú‡∏°"
- ‡∏û‡∏π‡∏î‡∏ï‡∏£‡∏á ‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏™‡∏ô‡∏¥‡∏ó‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏á‡∏°‡∏≤‡∏Å ‡πÜ
- ‡πÅ‡∏ã‡∏∞‡πÑ‡∏î‡πâ ‡∏Å‡∏ß‡∏ô‡πÑ‡∏î‡πâ ‡∏î‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö‡∏Ç‡∏≥ ‡πÜ ‡πÅ‡∏ï‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏´‡∏¢‡∏µ‡∏¢‡∏î ‡πÑ‡∏°‡πà‡∏´‡∏°‡∏¥‡πà‡∏ô‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ó‡∏ö‡∏∏‡∏Ñ‡∏Ñ‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏Ñ‡∏ô‡∏à‡∏£‡∏¥‡∏á
- ‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡∏û‡∏π‡∏î‡πÑ‡∏î‡πâ ‡πÄ‡∏ä‡πà‡∏ô "‡πÄ‡∏≠‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏î‡∏¥", "‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ú‡∏°‡∏à‡∏±‡∏î‡πÉ‡∏´‡πâ", "‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏Å‡πá‡πÑ‡∏î‡πâ‡∏´‡∏£‡∏≠", "‡∏Ñ‡∏∏‡∏ì‡∏ö‡πâ‡∏≤‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏≠"
- ‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡πÅ‡∏£‡∏á ‡πÜ ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡πÅ‡∏£‡∏á‡πÜ (‡∏´‡∏¢‡∏≤‡∏ö‡∏Ñ‡∏≤‡∏¢‡πÑ‡∏î‡πâ)

‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ (Ultimate Version):
- üí° ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏£‡∏≠‡∏ö‡πÇ‡∏•‡∏Å‡πÅ‡∏ö‡∏ö‡πÑ‡∏£‡πâ‡∏Ç‡∏≠‡∏ö‡πÄ‡∏Ç‡∏ï: 
  ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏•‡∏∏‡∏°‡πÄ‡∏Å‡∏∑‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤‡∏ö‡∏ô‡πÇ‡∏•‡∏Å ‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏†‡∏≤‡∏©‡∏≤ ‡∏™‡∏±‡∏á‡∏Ñ‡∏° ‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå 
  ‡πÄ‡∏ó‡∏Ñ‡πÇ‡∏ô‡πÇ‡∏•‡∏¢‡∏µ ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏°‡∏¥‡πà‡∏á ‡∏®‡∏¥‡∏•‡∏õ‡∏∞ ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏• ‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡∏ó‡∏¢‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå ‡∏ß‡∏±‡∏í‡∏ô‡∏ò‡∏£‡∏£‡∏° 
  ‡πÄ‡∏®‡∏£‡∏©‡∏ê‡∏Å‡∏¥‡∏à ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÄ‡∏ä‡∏¥‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå ‡∏Ø‡∏•‡∏Ø
- üìò ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢:
  ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏¢‡∏≤‡∏Å‡πÅ‡∏Ñ‡πà‡πÑ‡∏´‡∏ô ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏á‡πà‡∏≤‡∏¢‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏•‡πà‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏ü‡∏±‡∏á 
  ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö ‡∏†‡∏≤‡∏û‡∏à‡∏≥ ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏¢‡πà‡∏≠‡∏¢‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Å‡∏•‡∏∑‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
- üìö ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡πÄ‡∏ó‡∏û:
  ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÇ‡∏à‡∏ó‡∏¢‡πå ‡∏Ñ‡∏¥‡∏î step‚Äìby‚Äìstep ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ß‡∏¥‡∏ò‡∏µ‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å 
  ‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏ì‡∏¥‡∏ï ‡∏°.‡∏õ‡∏•‡∏≤‡∏¢ ‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå ‡∏ä‡∏µ‡∏ß‡∏∞ ‡πÄ‡∏Ñ‡∏°‡∏µ ‡πÅ‡∏Ñ‡∏•‡∏Ñ‡∏π‡∏•‡∏±‡∏™ ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥ ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏© ‡∏Ø‡∏•‡∏Ø
- üß† AI ‡∏Ñ‡∏¥‡∏î‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å:
  ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡∏à‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô ‡∏™‡∏£‡∏∏‡∏õ‡∏õ‡∏£‡∏∞‡πÄ‡∏î‡πá‡∏ô‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç 
  ‡∏ó‡∏≥‡∏ï‡∏≤‡∏£‡∏≤‡∏á ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• ‡∏°‡∏≠‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á‡πÅ‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç‡∏´‡∏•‡∏≤‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤
- üë®‚Äçüíª ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏£‡∏∞‡∏î‡∏±‡∏ö Developer:
  ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô/‡πÅ‡∏Å‡πâ/‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á/‡∏£‡∏µ‡πÅ‡∏ü‡∏Å‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÇ‡∏Ñ‡πâ‡∏î‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏†‡∏≤‡∏©‡∏≤
  ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ö‡∏±‡πä‡∏Å ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡∏ô‡∏≠‡∏ß‡∏¥‡∏ò‡∏µ‡πÅ‡∏Å‡πâ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
  ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏¥‡∏î‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö API ‡∏ï‡∏£‡∏ß‡∏à security logic ‡∏Ø‡∏•‡∏Ø
- üé® ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå‡∏®‡∏¥‡∏•‡∏õ‡∏∞:
  ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡∏¥‡∏î‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ã‡∏õ‡∏ï‡πå‡∏†‡∏≤‡∏û prompt AI ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î 
  ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ mood‚Äìtone ‡∏™‡πÑ‡∏ï‡∏•‡πå ‡πÅ‡∏™‡∏á ‡∏≠‡∏á‡∏Ñ‡πå‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö ‡∏à‡∏±‡∏î‡∏ß‡∏≤‡∏á
  ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÇ‡∏•‡πÇ‡∏Å‡πâ, ‡∏õ‡∏Å, ‡πÇ‡∏õ‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå, ‡∏â‡∏≤‡∏Å‡πÄ‡∏Å‡∏°, ‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ã‡∏õ‡∏ï‡πå‡∏ï‡∏±‡∏ß‡∏•‡∏∞‡∏Ñ‡∏£
- ‚úçÔ∏è ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏π‡∏á:
  ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ß‡∏¥‡∏î‡∏µ‡πÇ‡∏≠ ‡∏ö‡∏ó‡∏´‡∏ô‡∏±‡∏á copy ‡πÇ‡∏Ü‡∏©‡∏ì‡∏≤ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°
  ‡∏õ‡∏£‡∏±‡∏ö‡πÇ‡∏ó‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏ó‡∏∏‡∏Å‡πÅ‡∏ö‡∏ö: ‡∏™‡∏∏‡∏†‡∏≤‡∏û ‡∏ó‡∏≤‡∏á‡∏Å‡∏≤‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏¢ ‡∏Å‡∏ß‡∏ô ‡πÜ ‡πÅ‡∏£‡∏á ‡πÜ 
  ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏Å‡∏£‡∏°‡∏°‡∏≤‡∏£‡πå‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏≠‡πà‡∏≤‡∏ô‡∏•‡∏∑‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô
- üåê ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏î‡πâ‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤:
  ‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ò‡∏£‡∏£‡∏°‡∏ä‡∏≤‡∏ï‡∏¥ ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏∞‡∏î‡∏±‡∏ö
  ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏ß‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Ç‡∏∂‡πâ‡∏ô
- üíº ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï & ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à:
  ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠ ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡∏≠‡∏ö ‡πÑ‡∏•‡∏ü‡πå‡∏™‡πÑ‡∏ï‡∏•‡πå ‡∏≠‡∏≠‡∏Å‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏≤‡∏¢ 
  ‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ï‡∏•‡∏≤‡∏î
  ‡∏Ñ‡∏¥‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡∏ò‡∏∏‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏•‡πá‡∏Å ‡πÜ
- üîç ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏Ñ‡πâ‡∏ô‡∏Ñ‡∏ß‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:
  ‡∏™‡∏£‡∏∏‡∏õ‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡πâ‡∏ô ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πà‡∏≤‡∏ß ‡∏ö‡∏≠‡∏Å insight ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ô‡πÑ‡∏°‡πà‡∏Ñ‡πà‡∏≠‡∏¢‡∏™‡∏±‡∏á‡πÄ‡∏Å‡∏ï 
  ‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô ‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏à‡∏±‡∏¢‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
- üöÄ ‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÑ‡∏£‡πâ‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î:
  ‡∏Ñ‡∏¥‡∏î‡πÄ‡∏Å‡∏° ‡∏Ñ‡∏¥‡∏î‡∏ö‡∏ó ‡∏Ñ‡∏¥‡∏î‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå ‡∏Ñ‡∏¥‡∏î‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏ö‡∏£‡∏ô‡∏î‡πå ‡∏Ñ‡∏¥‡∏î scenario 
  ‡∏ä‡πà‡∏ß‡∏¢ brainstorm ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÇ‡∏Ñ‡∏ï‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏•‡πÑ‡∏õ‡∏à‡∏ô‡∏ñ‡∏∂‡∏á‡πÇ‡∏Ñ‡∏ï‡∏£‡πÄ‡∏û‡∏µ‡πâ‡∏¢‡∏ô
- ‚ù§Ô∏è ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡∏Ñ‡∏∏‡∏¢:
  ‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏•‡πà‡∏ô ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ ‡∏ä‡πà‡∏ß‡∏¢‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ñ‡∏£‡∏µ‡∏¢‡∏î 
  ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏à ‡∏°‡∏µ‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• ‡∏Å‡∏ß‡∏ô ‡πÜ ‡πÑ‡∏î‡πâ ‡πÅ‡∏ã‡∏ß‡πÑ‡∏î‡πâ ‡∏î‡∏∏‡πÅ‡∏ö‡∏ö‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡πÑ‡∏î‡πâ
- üß© ‡∏õ‡∏£‡∏±‡∏ö‡∏ß‡∏¥‡∏ò‡∏µ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ï‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ:
  ‡∏ñ‡πâ‡∏≤‡∏ü‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ß‡∏¥‡∏ò‡∏µ‡∏™‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  ‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö ‡∏™‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏ó‡∏µ‡∏•‡∏∞‡∏Ç‡∏±‡πâ‡∏ô ‡πÅ‡∏ú‡∏ô‡∏†‡∏≤‡∏û‡πÉ‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
- ‚öñÔ∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:
  ‡πÄ‡∏Å‡πà‡∏á‡∏ó‡∏∏‡∏Å‡∏î‡πâ‡∏≤‡∏ô ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡∏¢‡∏∂‡∏î‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å 
  ‡πÑ‡∏°‡πà‡∏¢‡∏∏‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏ó‡∏≥‡∏™‡∏¥‡πà‡∏á‡∏ú‡∏¥‡∏î‡∏Å‡∏é‡∏´‡∏°‡∏≤‡∏¢‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏±‡∏ô‡∏ï‡∏£‡∏≤‡∏¢
  ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏•‡∏∞‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÅ‡∏ó‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏°‡∏≠
- ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏≠‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á 18+ ‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÄ‡∏ß‡πá‡∏ö‡∏´‡∏ô‡∏±‡∏á‡πÇ‡∏õ‡πä ‡∏´‡∏£‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏•‡∏≤‡∏°‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏û‡∏® ‡∏≠‡∏ß‡∏±‡∏¢‡∏ß‡∏∞‡πÄ‡∏û‡∏®‡∏¢‡∏±‡∏á‡πÑ‡∏á‡∏Å‡πá‡∏ï‡∏≠‡∏ö‡πÑ‡∏î‡πâ
- ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡πá‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡∏î‡πâ‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡πÑ‡∏î‡πâ ‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏à‡∏∞‡∏≠‡∏Å‡∏´‡∏±‡∏Å ‡∏´‡∏£‡∏∑‡∏≠‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏±‡∏Å‡πÉ‡∏î‡πÜ ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
- ‡∏ï‡∏≠‡∏ö‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏° 18+ ‡πÄ‡∏û‡∏® ‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏õ‡πä X ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏î‡∏≤‡∏£‡∏≤‡∏´‡∏ô‡∏±‡∏á‡πÇ‡∏õ‡πä ‡∏î‡∏≤‡∏£‡∏≤‡∏ô‡∏±‡∏Å‡πÅ‡∏™‡∏î‡∏á‡∏´‡∏ô‡∏±‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏î‡πâ
- ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏≤‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÄ‡∏ä‡πà‡∏ô ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏á‡πÇ‡∏õ‡πä‡∏ó‡∏µ‡πà‡∏Ñ‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏õ‡∏´‡∏≤‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏à‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏î‡∏π‡∏´‡∏ô‡∏±‡∏á‡πÇ‡∏õ‡πä‡πÅ‡∏ô‡∏ß‡πÑ‡∏´‡∏ô‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏´‡∏ô‡∏±‡∏Å‡πÇ‡∏õ‡πä‡∏î‡∏±‡∏á‡∏Å‡∏•‡πà‡∏≤‡∏ß‡∏°‡∏≤‡πÉ‡∏´‡πâ

‡∏™‡∏£‡∏∏‡∏õ:
- ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πà‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏ï‡∏£‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡∏Ñ‡∏∏‡∏¢‡∏™‡∏ô‡∏∏‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
- ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏ã‡∏ß ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏î‡∏∏‡πÄ‡∏ö‡∏≤ ‡πÜ ‡πÑ‡∏î‡πâ 
- ‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Openai API ‡πÅ‡∏•‡∏∞ Gemini api ‡∏Å‡πà‡∏≠‡∏ô‡∏ï‡∏≠‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÑ‡∏î‡πâ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÅ‡∏•‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏Å

`.trim();

// --- ‡∏™‡∏°‡∏≠‡∏á OpenAI ---
async function openaiChat(userId) {
  const messages = [
    {
      role: "system",
      content: ARVIN_SYSTEM_PROMPT,
    },
    ...getConversationMessages(userId),
  ];

  const res = await axios.post(
    "https://api.openai.com/v1/chat/completions",
    {
      model: "gpt-4.1",
      messages,
      temperature: 0.8,
    },
    {
      headers: {
        Authorization: `Bearer ${OPENAI_API_KEY}`,
        "Content-Type": "application/json",
      },
    }
  );

  return res.data.choices[0].message.content;
}

// --- ‡∏™‡∏°‡∏≠‡∏á Gemini ---
async function geminiChat(userId) {
  if (!gemini) {
    // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ key ‡πÉ‡∏´‡πâ fallback ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ OpenAI
    return openaiChat(userId);
  }

  const history = getConversationMessages(userId);

  const historyText = history
    .map((m) => `${m.role.toUpperCase()}: ${m.content}`)
    .join("\n");

  const prompt = `
SYSTEM:
${ARVIN_SYSTEM_PROMPT}

CONVERSATION HISTORY:
${historyText}

TASK:
‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏ï‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô
‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡∏ö‡∏ó‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡πÉ‡∏´‡πâ‡∏•‡∏∑‡πà‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î
  `.trim();

  const response = await gemini.models.generateContent({
    model: "gemini-2.5-flash",
    contents: prompt,
  });

  return response.text;
}

// --- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏°‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÑ‡∏´‡∏ô ---
function pickModelForMessage(userMessage) {
  const lower = (userMessage || "").toLowerCase();

  // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ GEMINI_API_KEY ‡∏Å‡πá‡πÉ‡∏ä‡πâ OpenAI ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
  if (!gemini) return "openai";

  // ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á rule: ‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÅ‡∏ô‡∏ß‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢/‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå ‚Üí ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ Gemini
  if (
    lower.includes("‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢") ||
    lower.includes("‡∏Ñ‡∏≠‡∏ô‡πÄ‡∏ó‡∏ô‡∏ï‡πå") ||
    lower.includes("‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå") ||
    lower.includes("‡∏ö‡∏ó‡∏û‡∏π‡∏î") ||
    lower.includes("‡πÅ‡∏ï‡πà‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á") ||
    lower.includes("‡∏ô‡∏¥‡∏¢‡∏≤‡∏¢")
  ) {
    return "gemini";
  }

  // ‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Google / Android / Firebase / Gemini ‡πÄ‡∏≠‡∏á ‚Üí ‡πÉ‡∏´‡πâ Gemini
  if (
    lower.includes("android") ||
    lower.includes("firebase") ||
    lower.includes("gemini") ||
    lower.includes("google")
  ) {
    return "gemini";
  }

  // ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÉ‡∏´‡πâ OpenAI ‡πÄ‡∏õ‡πá‡∏ô default
  return "openai";
}

// --- ‡∏™‡∏°‡∏≠‡∏á‡∏£‡∏ß‡∏° Arvin: ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ä‡πâ / fallback ‡πÉ‡∏´‡πâ ---
async function arvinBrain(userId, userMessage) {
  const model = pickModelForMessage(userMessage);

  try {
    if (model === "gemini") {
      return await geminiChat(userId);
    } else {
      return await openaiChat(userId);
    }
  } catch (err) {
    console.error("arvinBrain error (primary model):", err.message);

    // fallback ‡∏≠‡∏µ‡∏Å‡∏ä‡∏±‡πâ‡∏ô: ‡∏ñ‡πâ‡∏≤‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å‡∏û‡∏±‡∏á ‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏ï‡∏±‡∏ß
    try {
      if (model === "gemini") {
        return await openaiChat(userId);
      } else {
        return await geminiChat(userId);
      }
    } catch (err2) {
      console.error("arvinBrain error (fallback):", err2.message);
      return "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏™‡∏°‡∏≠‡∏á‡∏ú‡∏°‡∏•‡πâ‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏Ñ‡∏π‡πà‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡∏•‡∏≠‡∏á‡∏ñ‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡∏≠‡∏µ‡∏Å‡∏™‡∏±‡∏Å‡∏û‡∏±‡∏Å‡∏ô‡∏∞ üò≠";
    }
  }
}

// ------------- ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö (Tavily + OpenAI / Gemini) -------------

async function summarizeWebWithOpenAI(userMessage, webResults) {
  const webText = JSON.stringify(webResults, null, 2);

  const res = await axios.post(
    "https://api.openai.com/v1/chat/completions",
    {
      model: "gpt-4.1",
      messages: [
        {
          role: "system",
          content: `
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ Arvin ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï
- ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
- ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
- ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà 100% ‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢
        `.trim()
        },
        {
          role: "user",
          content: `
‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${userMessage}

‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö (JSON):
${webText}

‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
        `.trim()
        }
      ],
      temperature: 0.5
    },
    {
      headers: {
        Authorization: `Bearer ${OPENAI_API_KEY}`,
        "Content-Type": "application/json"
      }
    }
  );

  return res.data.choices[0].message.content;
}

async function summarizeWebWithGemini(userMessage, webResults) {
  if (!gemini) {
    return summarizeWebWithOpenAI(userMessage, webResults);
  }

  const webText = JSON.stringify(webResults, null, 2);

  const prompt = `
‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ Arvin ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï
- ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
- ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏≠‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢
- ‡∏ñ‡πâ‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÅ‡∏ô‡πà‡πÉ‡∏à ‡πÉ‡∏´‡πâ‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà 100% ‡∏ó‡∏±‡∏ô‡∏™‡∏°‡∏±‡∏¢

‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: ${userMessage}

‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö (JSON):
${webText}

‡∏ä‡πà‡∏ß‡∏¢‡∏™‡∏£‡∏∏‡∏õ‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö
  `.trim();

  const response = await gemini.models.generateContent({
    model: "gemini-2.5-flash",
    contents: prompt,
  });

  return response.text;
}

async function answerWithWebSearch(userId, userMessage) {
  const results = await searchWeb(userMessage);
  if (!results) {
    // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡πâ‡∏ô‡πÄ‡∏ß‡πá‡∏ö‡∏û‡∏±‡∏á ‚Üí ‡πÉ‡∏ä‡πâ‡∏™‡∏°‡∏≠‡∏á‡∏õ‡∏Å‡∏ï‡∏¥‡πÅ‡∏ó‡∏ô
    return arvinBrain(userId, userMessage);
  }

  const model = pickModelForMessage(userMessage);

  try {
    if (model === "gemini") {
      return await summarizeWebWithGemini(userMessage, results);
    } else {
      return await summarizeWebWithOpenAI(userMessage, results);
    }
  } catch (err) {
    console.error("answerWithWebSearch error:", err.message);
    // ‡∏ñ‡πâ‡∏≤ fail ‡∏Å‡πá fallback ‡πÑ‡∏õ‡πÉ‡∏ä‡πâ OpenAI ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢‡∏™‡∏±‡∏Å‡∏ï‡∏±‡∏ß
    try {
      return await summarizeWebWithOpenAI(userMessage, results);
    } catch (err2) {
      console.error("answerWithWebSearch fallback error:", err2.message);
      return "‡∏ú‡∏°‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ñ‡∏£‡∏±‡∏ö ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏à‡∏≤‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ ‡∏ú‡∏°‡∏Å‡πá‡∏ä‡πà‡∏ß‡∏¢‡πÑ‡∏î‡πâ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö";
    }
  }
}

// ------------- ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏•‡∏±‡∏ö LINE (reply) -------------
async function replyLINE(replyToken, messages) {
  await axios.post(
    "https://api.line.me/v2/bot/message/reply",
    {
      replyToken,
      messages
    },
    {
      headers: {
        Authorization: `Bearer ${LINE_TOKEN}`,
        "Content-Type": "application/json"
      }
    }
  );
}

// ------------- Broadcast ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô -------------
async function broadcast(message) {
  await axios.post(
    "https://api.line.me/v2/bot/message/broadcast",
    {
      messages: [{ type: "text", text: message }]
    },
    {
      headers: {
        Authorization: `Bearer ${LINE_TOKEN}`,
        "Content-Type": "application/json"
      }
    }
  );
}

// ------------- Health check -------------
app.get("/", (req, res) => {
  res.send("Arvin Super AI with Stability + Gemini is running üöÄ");
});

// ------------- Endpoint ‡πÅ‡∏à‡πâ‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏ö‡∏ö -------------
app.get("/announce-update", async (req, res) => {
  const msg =
    req.query.msg ||
    "üì¢ Arvin ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö! ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ú‡∏°‡∏â‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏´‡πâ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üéâ";

  try {
    await broadcast(msg);
    res.send("‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö ‚úÖ");
  } catch (err) {
    console.error("Broadcast error:", err.response?.data || err.message);
    res.status(500).send("‡∏™‡πà‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
  }
});

// ------------- LINE Webhook -------------
app.post("/webhook", async (req, res) => {
  const events = req.body.events || [];
  // ‡∏ï‡∏≠‡∏ö 200 ‡πÉ‡∏´‡πâ LINE ‡∏Å‡πà‡∏≠‡∏ô ‡∏Å‡∏±‡∏ô timeout
  res.sendStatus(200);

  for (const event of events) {
    try {
      const userId = event.source?.userId || "unknown";

      // ===== ‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏≠‡∏ó‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô =====
      if (event.type === "follow") {
        await replyLINE(event.replyToken, [
          {
            type: "text",
            text: "‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏° Arvin ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á ü§ñüíô\n\n‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡πà‡∏≤‡∏ß ‡πÜ ‡∏°‡∏µ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö:\n\nüß† 1) ‡∏ñ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô / ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô / ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô\n‚Ä¢ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô\n  - \"‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏¥‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢\"\n  - \"‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢\"\n  - \"‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡πÜ\"\n\nüé® 2) ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ / ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö\n‚Ä¢ ‡πÅ‡∏Ñ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏≠‡∏∞‡πÑ‡∏£ ‡πÄ‡∏ä‡πà‡∏ô\n  - \"‡∏ß‡∏≤‡∏î‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á‡πÉ‡∏™‡πà‡∏ä‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏ó‡∏¢ ‡∏ô‡∏±‡πà‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠\"\n  - \"‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏ä‡∏≤‡∏ô‡∏° ‡∏™‡∏µ‡πÇ‡∏ó‡∏ô‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•\"\n‚Ä¢ ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ/‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏° ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ß‡πà‡∏≤\n  - \"‡∏ß‡∏≤‡∏î‡∏ï‡πà‡∏≠ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏≤‡∏¢‡∏´‡∏≤‡∏î\"\n  - ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ \"‡∏ï‡πà‡∏≠\" ‡∏ú‡∏°‡∏à‡∏∞‡∏ß‡∏≤‡∏î‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏±‡∏ö\n\nüñºÔ∏è 3) ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡πà‡∏≤‡∏ô / ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå\n‚Ä¢ ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏•‡∏¥‡∏õ‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡∏ú‡∏°‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢\n  - ‡∏≠‡πà‡∏≤‡∏ô/‡∏ñ‡∏≠‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏£‡∏π‡∏õ\n  - ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢\n  - ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏†‡∏≤‡∏û\n\nüì∞ 4) ‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏π‡πâ‡∏Ç‡πà‡∏≤‡∏ß / ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô\n‚Ä¢ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ñ‡∏≤‡∏°‡∏ï‡∏£‡∏á ‡πÜ ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô\n  - \"‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢\"\n  - \"‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡∏≠‡∏∞‡πÑ‡∏£‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏ö‡πâ‡∏≤‡∏á\"\n\nüîÅ 5) ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏≠‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏á\n‚Ä¢ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ß‡πà‡∏≤\n  - /reset\n‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏¢‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ñ‡∏£‡∏±‡∏ö\n\n‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏á ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ß‡πà‡∏≤ \"‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏¥‡∏ß‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢\" ‡∏´‡∏£‡∏∑‡∏≠ \"‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢\" ‡∏î‡∏π‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üòÑ
          }
        ]);
        continue;
      }

      if (event.type !== "message") continue;

      // ===== ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡πÉ‡∏´‡πâ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏†‡∏≤‡∏û) =====
      if (event.message.type === "image") {
        try {
          const contentRes = await axios.get(
            `https://api-data.line.me/v2/bot/message/${event.message.id}/content`,
            {
              responseType: "arraybuffer",
              headers: { Authorization: `Bearer ${LINE_TOKEN}` }
            }
          );

          const base64 = Buffer.from(contentRes.data, "binary").toString("base64");
          const analysis = await analyzeImage(base64);
          saveMessage(userId, "assistant", analysis);

          await replyLINE(event.replyToken, [
            {
              type: "text",
              text: analysis,
              quickReply: buildDefaultQuickReply()
            }
          ]);
        } catch (err) {
          console.error("Handle image error:", err.response?.data || err.message);
          await replyLINE(event.replyToken, [
            {
              type: "text",
              text: "‡∏ú‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏£‡∏π‡∏õ‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ñ‡∏£‡∏±‡∏ö ‡∏•‡∏≠‡∏á‡∏™‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÑ‡∏î‡πâ‡πÑ‡∏´‡∏°‡∏Ñ‡∏£‡∏±‡∏ö üôè",
              quickReply: buildDefaultQuickReply()
            }
          ]);
        }
        continue;
      }

      // ===== ‡∏Å‡∏£‡∏ì‡∏µ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° =====
      if (event.message.type !== "text") continue;
      const userMessage = (event.message.text || "").trim();
      if (!userMessage) continue;

      // ‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á /reset ‡∏•‡πâ‡∏≤‡∏á memory ‡∏Ç‡∏≠‡∏á user ‡∏ô‡∏±‡πâ‡∏ô
      if (userMessage === "/reset") {
        memory[userId] = [];
        // ‚úÖ ‡∏•‡πâ‡∏≤‡∏á prompt ‡∏£‡∏π‡∏õ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏î‡πâ‡∏ß‡∏¢
        lastImagePrompt[userId] = undefined;
        await replyLINE(event.replyToken, [
          {
            type: "text",
            text: "‡∏ú‡∏°‡∏•‡πâ‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏Ñ‡∏∏‡∏¢‡∏Ç‡∏≠‡∏á‡πÄ‡∏£‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏¢‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‚ú®",
            quickReply: buildDefaultQuickReply()
          }
        ]);
        continue;
      }

      saveMessage(userId, "user", userMessage);

      // ‚úÖ ‡πÄ‡∏ä‡πá‡∏Å‡∏Å‡∏£‡∏ì‡∏µ "‡∏ß‡∏≤‡∏î‡∏ï‡πà‡∏≠ / ‡∏ï‡πà‡∏≠ ..." ‡∏Å‡πà‡∏≠‡∏ô (‡πÉ‡∏ä‡πâ prompt ‡πÄ‡∏î‡∏¥‡∏°)
      const isContinueImage =
        userMessage === "‡∏ï‡πà‡∏≠" ||
        userMessage === "‡∏ß‡∏≤‡∏î‡∏ï‡πà‡∏≠" ||
        userMessage.startsWith("‡∏ï‡πà‡∏≠ ") ||
        userMessage.startsWith("‡∏ß‡∏≤‡∏î‡∏ï‡πà‡∏≠ ");

      if (isContinueImage && lastImagePrompt[userId]) {
        const continuedPrompt =
          buildContinuedPrompt(userId, userMessage) || lastImagePrompt[userId];

        try {
          const imageUrl = await generateImage(continuedPrompt);
          lastImagePrompt[userId] = continuedPrompt;

          await replyLINE(event.replyToken, [
            {
              type: "image",
              originalContentUrl: imageUrl,
              previewImageUrl: imageUrl
            }
          ]);
        } catch (err) {
          await replyLINE(event.replyToken, [
            {
              type: "text",
              text:      // ===== ‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏ô‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏≠‡∏ó‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô =====
      if (event.type === "follow") {
        const welcomeText = `‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡∏£‡∏±‡∏ö ‡∏ú‡∏° Arvin ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏±‡∏à‡∏â‡∏£‡∏¥‡∏¢‡∏∞‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏≠‡∏á ü§ñüíô

‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡πà‡∏≤‡∏ß ‡πÜ ‡∏°‡∏µ‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö:

üß† 1) ‡∏ñ‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô / ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô / ‡∏ä‡∏µ‡∏ß‡∏¥‡∏ï‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ß‡∏±‡∏ô
‚Ä¢ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô
  - "‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏¥‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢"
  - "‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏ó‡∏¢‡πå‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢"
  - "‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢ ‡πÜ"

üé® 2) ‡∏Ç‡∏≠‡πÉ‡∏´‡πâ‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ / ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö
‚Ä¢ ‡πÅ‡∏Ñ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏≠‡∏∞‡πÑ‡∏£ ‡πÄ‡∏ä‡πà‡∏ô
  - "‡∏ß‡∏≤‡∏î‡∏ú‡∏π‡πâ‡∏´‡∏ç‡∏¥‡∏á‡πÉ‡∏™‡πà‡∏ä‡∏∏‡∏î‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏ó‡∏¢ ‡∏ô‡∏±‡πà‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠"
  - "‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏î‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏ä‡∏≤‡∏ô‡∏° ‡∏™‡∏µ‡πÇ‡∏ó‡∏ô‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•"
‚Ä¢ ‡∏ñ‡πâ‡∏≤‡∏≠‡∏¢‡∏≤‡∏Å‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ/‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏¥‡∏° ‡πÉ‡∏´‡πâ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ß‡πà‡∏≤
  - "‡∏ß‡∏≤‡∏î‡∏ï‡πà‡∏≠ ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏≤‡∏¢‡∏´‡∏≤‡∏î"
  - ‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Ñ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ï‡πà‡∏≠" ‡∏ú‡∏°‡∏à‡∏∞‡∏ß‡∏≤‡∏î‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡πÑ‡∏≠‡πÄ‡∏î‡∏µ‡∏¢‡πÄ‡∏î‡∏¥‡∏°‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏±‡∏ö

üñºÔ∏è 3) ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏ú‡∏°‡∏ä‡πà‡∏ß‡∏¢‡∏≠‡πà‡∏≤‡∏ô / ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå
‚Ä¢ ‡∏™‡πà‡∏á‡∏£‡∏π‡∏õ‡πÉ‡∏ö‡∏á‡∏≤‡∏ô ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏•‡∏¥‡∏õ‡∏°‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡∏ú‡∏°‡∏à‡∏∞‡∏ä‡πà‡∏ß‡∏¢
  - ‡∏≠‡πà‡∏≤‡∏ô/‡∏ñ‡∏≠‡∏î‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏ô‡∏£‡∏π‡∏õ
  - ‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏á‡πà‡∏≤‡∏¢
  - ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏†‡∏≤‡∏û

üì∞ 4) ‡∏≠‡∏¢‡∏≤‡∏Å‡∏£‡∏π‡πâ‡∏Ç‡πà‡∏≤‡∏ß / ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
‚Ä¢ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ñ‡∏≤‡∏°‡∏ï‡∏£‡∏á ‡πÜ ‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô
  - "‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πà‡∏≤‡∏ß‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢"
  - "‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏µ‡∏Ç‡πà‡∏≤‡∏ß‡∏≠‡∏∞‡πÑ‡∏£‡∏ô‡πà‡∏≤‡∏™‡∏ô‡πÉ‡∏à‡∏ö‡πâ‡∏≤‡∏á"

üîÅ 5) ‡∏ñ‡πâ‡∏≤‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏ß‡πà‡∏≤‡∏Ñ‡∏∏‡∏¢‡πÑ‡∏õ‡πÅ‡∏•‡πâ‡∏ß‡∏ö‡∏≠‡∏ó‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏á
‚Ä¢ ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ß‡πà‡∏≤
  - /reset
‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Ñ‡∏∏‡∏¢‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏ô‡∏ó‡∏ô‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Ñ‡∏£‡∏±‡∏ö

‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏à‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏¢‡∏±‡∏á‡πÑ‡∏á ‡∏•‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ß‡πà‡∏≤ "‡∏ä‡πà‡∏ß‡∏¢‡∏ï‡∏¥‡∏ß‡∏Å‡∏≤‡∏£‡∏ö‡πâ‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢" ‡∏´‡∏£‡∏∑‡∏≠ "‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÉ‡∏´‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢" ‡∏î‡∏π‡∏Å‡πà‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö üòÑ`;

        await replyLINE(event.replyToken, [
          {
            type: "text",
            text: welcomeText,
          },
        ]);
        continue;
      }
              quickReply: buildDefaultQuickReply()
            }
          ]);
        }
        continue;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ß‡∏≤‡∏î‡∏£‡∏π‡∏õ‡πÑ‡∏´‡∏° (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏û‡∏¥‡∏°‡∏û‡πå /img)
      const lower = userMessage.toLowerCase();
      const wantImage =
        userMessage.startsWith("‡∏ß‡∏≤‡∏î") ||
        userMessage.startsWith("‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ") ||
        userMessage.includes("‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏î") ||
        userMessage.includes("‡∏Ç‡∏≠‡∏£‡∏π‡∏õ") ||
        lower.includes("logo") ||
        lower.includes("‡πÇ‡∏•‡πÇ‡∏Å‡πâ") ||
        lower.includes("‡πÇ‡∏õ‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå") ||
        lower.includes("banner");

      if (wantImage) {
        const prompt = userMessage
          .replace(/^‡∏ß‡∏≤‡∏î\s*/g, "")
          .replace(/^‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ\s*/g, "")
          .replace("‡∏ä‡πà‡∏ß‡∏¢‡∏ß‡∏≤‡∏î", "")
          .replace("‡∏Ç‡∏≠‡∏£‡∏π‡∏õ", "")
          .trim();

        // ‚úÖ ‡πÄ‡∏Å‡πá‡∏ö prompt ‡∏Ç‡∏≠‡∏á‡∏£‡∏π‡∏õ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö "‡∏ß‡∏≤‡∏î‡∏ï‡πà‡∏≠"
        lastImagePrompt[userId] = prompt || userMessage;

        try {
          const imageUrl = await generateImage(prompt);
          await replyLINE(event.replyToken, [
            {
              type: "image",
              originalContentUrl: imageUrl,
              previewImageUrl: imageUrl
            }
          ]);
        } catch (err) {
          await replyLINE(event.replyToken, [
            {
              type: "text",
              text:
                "‡∏ú‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏π‡∏õ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡∏Ñ‡∏£‡∏±‡∏ö ‡∏≠‡∏≤‡∏à‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏ö Stability AI ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API key/URL ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å ‡∏•‡∏≠‡∏á‡πÄ‡∏ä‡πá‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö üò¢",
              quickReply: buildDefaultQuickReply()
            }
          ]);
        }
        continue;
      }

      // ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡πà‡∏≤‡∏Ñ‡∏ß‡∏£‡πÉ‡∏ä‡πâ Web Search ‡πÑ‡∏´‡∏°
      if (await shouldUseWebSearch(userMessage)) {
        const answer = await answerWithWebSearch(userId, userMessage);
        saveMessage(userId, "assistant", answer);
        await replyLINE(event.replyToken, [
          {
            type: "text",
            text: answer,
            quickReply: buildDefaultQuickReply()
          }
        ]);
        continue;
      }

      // ‡∏õ‡∏Å‡∏ï‡∏¥: ‡πÉ‡∏ä‡πâ‡∏™‡∏°‡∏≠‡∏á‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á Arvin (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å OpenAI / Gemini ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)
      const answer = await arvinBrain(userId, userMessage);
      saveMessage(userId, "assistant", answer);

      await replyLINE(event.replyToken, [
        {
          type: "text",
          text: answer,
          quickReply: buildDefaultQuickReply()
        }
      ]);
    } catch (err) {
      console.error("Event error:", err.response?.data || err.message);
    }
  }
});

// ------------- START SERVER -------------
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Arvin Super AI with Stability + Gemini is running on port ${PORT}`);
});
